{% extends "base.html" %}
{% block title %}
  RAGSpert Index: Start crawling
{% endblock title %}
{% block content %}
  <div id="maincontent">
    <h1>RAGspert Index: start crawling</h1>
    {% if flash_msg %}<div id="flashMessage">{{ flash_msg }}</div>{% endif %}
    <form id="addCrawlerForm"
          method="POST"
          action="{{ url_for('crawl_form') }}">
      <input type="url"
             class="crawlerInput"
             name="url"
             placeholder="Documentation URL"
             required>
      <input type="text"
             class="crawlerInput"
             name="name"
             placeholder="Name it"
             required>
      <button type="submit" class="btn">üï∑Ô∏è CRAWL</button>
    </form>
    <div class="contcent">
      <div class="childcent">
        {% if message %}
          <p class="success">{{ message }}</p>
          <div id="crawl-status">
            <p>‚è≥ Checking status...</p>
          </div>
        {% endif %}
      </div>
    </div>
    <div class="contcent">
      <div class="childcent">
        <p>EXAMPLES:</p>
        <ul>
          <li>"https://python-markdown.github.io/" - "python-markdown"</li>
          <li>"https://www.python-httpx.org/" - "HTTPX"</li>
          <li>"https://curl-cffi.readthedocs.io/en/latest/" - "curl-cffi"</li>
        </ul>
      </div>
    </div>
    <input type="checkbox"
           id="show-more-mainpage"
           class="show-more-checkbox-stock">
    <label for="show-more-mainpage"
           class="show-more-label-stock"
           style="width: auto">HOW-TO</label>
    <div class="more-text-stock">
      <p class="text-center">
        1. Add your favourite documentation
        <br>
        to your personal Knowledge Base.
      </p>
      <p class="text-center">2. give it a name for later reference,</p>
      <p class="text-center">
        3. Ask questions about it.
        <br>
        Faster Retrieval, Faster Learning!
      </p>
    </div>
  </div>
  {% if name %}
    <script>
      (async function() {
        const name = "{{ name }}";
        console.log("üîç Starting status polling for:", name);

        if (!name || name === "None") {
          console.error("‚ùå No valid name provided");
          return;
        }

        async function poll() {
          console.log("üì° Fetching status...");

          try {
            const url = `/agent/crawl/status/${encodeURIComponent(name)}`;
            console.log("URL:", url);

            const res = await fetch(url);
            console.log("Response status:", res.status);

            if (!res.ok) {
              console.error("‚ùå API error:", res.status);
              document.getElementById('crawl-status').innerHTML =
                `<p class="error">‚ùå API Error: ${res.status}</p>`;
              return;
            }

            const data = await res.json();
            console.log("üìä Status data:", data);

            const div = document.getElementById('crawl-status');

            if (data.status === 'running') {
              div.innerHTML = `
                <p>üï∑Ô∏è Crawling... ${data.processed}/${data.total_urls} pages</p>
                <p>‚ùå Errors: ${data.errors}</p>
              `;
              setTimeout(poll, 2000);
            }
            else if (data.status === 'finished') {
              div.innerHTML = `
                <p>‚úÖ Crawling completed!</p>
                <p>üìä Processed: ${data.processed} pages (${data.errors} errors)</p>
                <div class="contcent" style="margin:12px;"><div class="childcent"><div id="button-cont"><a href="/agent/ask" class="btn">‚ùì Ask RAGspert</a></div></div></div>
              `;
            }
            else {
              console.warn("‚ö†Ô∏è Unknown status:", data.status);
              div.innerHTML = `<p>‚è≥ Status: ${data.status}</p>`;
              setTimeout(poll, 2000);
            }

          } catch (err) {
            console.error("‚ùå Fetch error:", err);
            document.getElementById('crawl-status').innerHTML =
              `<p class="error">‚ùå Error: ${err.message}</p>`;
            setTimeout(poll, 5000);  // Retry in 5s
          }
        }

        poll();
      })();
    </script>
  {% endif %}
{% endblock content %}
